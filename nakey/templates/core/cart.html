{% extends './base.html' %}
{% load staticfiles %}
{% block head %}
<link rel="stylesheet" href="{% static 'css/cart.css'%}">
<title>Корзина</title>
{% endblock head %}
{% block content %}
<div class="container">
    <h3>Корзина</h3>
    <div class="row">
        <div class="col-12 col-md-9">
            <div class="item-list d-flex flex-wrap"></div>
        </div>
        <div class="col-12 col-md-3">
            <h3>Оформить заказ</h3>
            <table id="cart-detail">                
                <tbody>
                    <tr>
                        <td>Количество товаров</td>
                        <td>Общая цена</td>
                    </tr>
                    <tr>
                        <td class="cart-count">

                        </td>
                        <td class="cart-price">

                        </td>
                    </tr>
                </tbody>
            </table>
            <button class="btn btn-primary" onclick="clickRequest()">Отправить заявку</button>
        </div>
    </div>
</div>
{% endblock content %}
{% block scripts %}
<script>
    function renderCart(){
        var items = onGetCartItems();
        $(".item-list").empty();
        if(items.length == 0){
            $(".item-list").append("<p>Ваша корзина пуста</p>")
        }
        var allcount = 0;
        var  allprice = 0;
        items.map(item=>{
            allcount += Number(item.count);
            allprice += item.count*item.price;
            let data = { item: item };
            
            $("#cart_item_"+item.id+" .price").text(item.count*item.price+""); //
            $('#productCartPreviewTmpl').tmpl(data).appendTo('.item-list');
        });
        $("#cart-detail .cart-count").text(allcount);
        $("#cart-detail .cart-price").text(allprice);
    }
    function changeCount(e, item_id){
        // console.log("change count", item_id, e.value)
        onUpdateCartItem(item_id, e.value);
        renderCart();
    }
    function removeFromCart(item_id){
        onRemoveFromCart(item_id);
        renderCart();
    }
    function clickRequest(){
        $('#requestmodal').empty();
        $('#requestModalTmpl').tmpl({item_id: "name"}).appendTo('#requestmodal');
        $("#requestmodal .modal").modal('show');
    }
    function sendRequest({}){
        var data = {
            name: $('#requestmodal #name').val(),
            phone: $('#requestmodal #phone').val(),
            city: $('#requestmodal #city').val(),
            items: onGetCartItems()
        }
        console.log(data)
    }
</script>
<script>
    renderCart();
</script>
{% endblock scripts%}