{% extends './base.html' %}
{% load staticfiles %}
{% block head %}
<title>Корзина</title>
<style>
    .item-list .item{
        margin-bottom: 16px;
    }
</style>
{% endblock head %}
{% block content %}
<div class="container">
    <h3 class="mb-5">Ваша Корзина</h3>
    <div class="row">
        <div class="col-12 col-md-9">
            <div class="item-list d-flex flex-wrap"></div>
        </div>
        <div class="col-12 col-md-3 order">
        </div>
    </div>
</div>
{% endblock content %}
{% block scripts %}
<script>
</script>
<script>
    function renderCart(){
        var items = onGetCartItems();
        $(".item-list").empty();
        if(items.length == 0){
            $(".item-list").append("<p>Ваша корзина пуста, ищите товары <a href='/shop'>тут</a></p>")
            $(".order").empty();
        }else{
            $(".order").html(` <h3>Оформить заказ</h3>
            <table id="cart-detail">                
                <tbody>
                    <tr>
                        <td>Количество товаров</td>
                        <td>Общая цена</td>
                    </tr>
                    <tr>
                        <td class="cart-count">

                        </td>
                        <td class="cart-price">

                        </td>
                    </tr>
                </tbody>
            </table>
            <button class="btn btn-primary" onclick="clickRequest()">Отправить заявку</button>`);
        }

        var allcount = 0;
        var  allprice = 0;
        items.map(item=>{
            allcount += Number(item.count);
            allprice += item.count*item.price;
            let data = { item: item };
            
            $("#cart_item_"+item.id+" .price").text(item.count*item.price+""); //
            $('#productCartPreviewTmpl').tmpl(data).appendTo('.item-list');
        });
        $("#cart-detail .cart-count").text(allcount);
        $("#cart-detail .cart-price").html(allprice+'&nbsp;&#8376;');
    }
    function changeCount(e, item_id){
        // console.log("change count", item_id, e.value)
        onUpdateCartItem(item_id, e.value);
        renderCart();
    }
    function removeFromCart(item_id){
        onRemoveFromCart(item_id);
        renderCart();
    }
    function clickRequest(){
        if(onGetCartItems().length == 0){
            toastr.warning('Ваша корзина пуста')            
            return;
        }
        $('#requestmodal').empty();
        $('#requestModalTmpl').tmpl({items: JSON.stringify(onGetCartItems())}).appendTo('#requestmodal');
        $("#requestmodal .modal").modal('show');
    }
</script>
<script>
    renderCart();
</script>
{% endblock scripts%}